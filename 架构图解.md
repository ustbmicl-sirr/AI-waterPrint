# 屏内数字水印溯源系统 - 架构图解

## 1. 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户显示设备                                │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  应用程序 / 桌面环境                                          │  │
│  └─────────────────────────┬─────────────────────────────────────┘  │
│                            │                                        │
│  ┌─────────────────────────▼─────────────────────────────────────┐  │
│  │  系统合成器 (Compositor)                                      │  │
│  │  ├─ Windows: DirectComposition / DXGI                         │  │
│  │  ├─ macOS: CoreAnimation / Metal                              │  │
│  │  └─ Linux: X11 / Wayland                                      │  │
│  └─────────────────────────┬─────────────────────────────────────┘  │
│                            │                                        │
│  ┌─────────────────────────▼─────────────────────────────────────┐  │
│  │  端侧叠加服务 (Overlay Service)                              │  │
│  │  ├─ 水印生成引擎                                             │  │
│  │  ├─ GPU 渲染管理                                             │  │
│  │  ├─ 多屏管理                                                 │  │
│  │  └─ 策略控制                                                 │  │
│  └─────────────────────────┬─────────────────────────────────────┘  │
│                            │                                        │
│  ┌─────────────────────────▼─────────────────────────────────────┐  │
│  │  显示输出（含水印）                                          │  │
│  └─────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                              │
                    翻拍/录屏/截图
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        检测解码系统                                  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  Detect SDK (C++ 核心)                                        │  │
│  │  ├─ 预处理与几何校正                                         │  │
│  │  ├─ 频域变换与同步                                           │  │
│  │  ├─ 软判决解码                                               │  │
│  │  ├─ 纠错与解密                                               │  │
│  │  └─ 置信度评估                                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  CLI 工具 / REST 服务                                        │  │
│  │  ├─ wm-detect (本地检测)                                     │  │
│  │  ├─ /v1/detect (同步/异步检测)                               │  │
│  │  └─ /v1/detections (查询结果)                                │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        服务端管理系统                                │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  设备与会话管理                                              │  │
│  │  ├─ /v1/devices/enroll (设备注册)                            │  │
│  │  ├─ /v1/devices/{id} (设备查询/更新)                         │  │
│  │  ├─ /v1/sessions (会话创建/查询)                             │  │
│  │  └─ /v1/reports (溯源报告)                                   │  │
│  └───────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  密钥管理系统 (KMS)                                          │  │
│  │  ├─ 主密钥存储                                               │  │
│  │  ├─ 设备派生密钥                                             │  │
│  │  ├─ 会话短期密钥                                             │  │
│  │  └─ 密钥轮换与吊销                                           │  │
│  └───────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  数据存储与审计                                              │  │
│  │  ├─ 设备档案库                                               │  │
│  │  ├─ 检测记录库                                               │  │
│  │  ├─ 审计日志                                                 │  │
│  │  └─ 溯源报告库                                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

## 2. 端侧叠加流程

```
启动 OverlayService
    │
    ├─ 读取设备配置（device_id, endpoint）
    ├─ 连接 KMS 获取主密钥
    ├─ 初始化 GPU 渲染环境
    └─ 进入主循环
        │
        ├─ 每帧循环（60 FPS）
        │   ├─ 获取当前会话信息
        │   ├─ 生成载荷（device_id + session_id + timestamp）
        │   ├─ 加密与签名
        │   ├─ ECC 编码
        │   ├─ 频域嵌入（DWT+DCT+QIM）
        │   ├─ 同步模板合成
        │   ├─ 多尺度平铺
        │   ├─ JND 自适应强度调整
        │   ├─ 蓝噪声抖动
        │   ├─ GPU 渲染掩模
        │   └─ 合成到桌面
        │
        ├─ 监听系统事件
        │   ├─ 显示器热插拔
        │   ├─ 分辨率变化
        │   ├─ HDR 模式切换
        │   └─ 应用全屏切换
        │
        └─ 定期任务
            ├─ 密钥轮换检查
            ├─ 性能监控
            ├─ 日志上传
            └─ 策略更新
```

## 3. 水印嵌入算法流程

```
载荷数据 (96-128 bits)
    │
    ├─ 加密 (AES-256-GCM)
    ├─ 签名 (HMAC-SHA256)
    └─ ECC 编码 (BCH/RS)
        │
        ▼
    编码比特序列
        │
        ├─ DWT 分解 (2 级)
        │   └─ 获得 LH/HL 子带
        │
        ├─ 分块 DCT (8×8)
        │   └─ 获得中频系数
        │
        ├─ QIM 量化
        │   └─ 双阱量化映射比特
        │
        ├─ 同步模板
        │   ├─ 正弦格栅 1 (freq1, dir1)
        │   └─ 正弦格栅 2 (freq2, dir2)
        │
        ├─ 多尺度平铺
        │   ├─ 64×64 像素单元
        │   └─ 128×128 像素单元
        │
        ├─ 逆变换 (IDCT + IDWT)
        │   └─ 获得频域掩模
        │
        ├─ JND 自适应
        │   ├─ 计算局部对比度
        │   └─ 调整嵌入强度
        │
        ├─ 蓝噪声抖动
        │   └─ 掩蔽纹理
        │
        └─ GPU 渲染
            └─ 合成到桌面
```

## 4. 水印检测解码流程

```
输入图片/视频
    │
    ├─ 预处理
    │   ├─ 色彩空间转换
    │   ├─ 归一化
    │   └─ 边缘检测
    │
    ├─ 几何校正
    │   ├─ 屏幕区域提取
    │   ├─ 角点检测
    │   ├─ 单应性估计 (RANSAC)
    │   └─ 透视变换
    │
    ├─ 频域分析
    │   ├─ DWT 分解 (2 级)
    │   ├─ DCT 分块
    │   ├─ 频谱分析
    │   └─ 格栅峰值检测
    │
    ├─ 同步定位
    │   ├─ 旋转角估计
    │   ├─ 尺度估计
    │   └─ Log-polar 精细调整
    │
    ├─ 软判决解码
    │   ├─ QIM 软判决
    │   ├─ 多块投票
    │   ├─ 多尺度融合
    │   └─ 多帧融合 (视频)
    │
    ├─ 纠错解密
    │   ├─ BCH/RS 纠错
    │   ├─ AES-GCM 解密
    │   └─ HMAC 验证
    │
    ├─ 置信度评估
    │   ├─ 比特可靠性
    │   ├─ 同步质量
    │   ├─ 攻击类型识别
    │   └─ 综合评分
    │
    └─ 输出检测结果
        ├─ found: 是否检测到
        ├─ device_id: 设备标识
        ├─ session_ts: 时间戳
        ├─ score: 置信度
        └─ attack_hint: 攻击类型
```

## 5. 服务端溯源流程

```
接收检测结果
    │
    ├─ 验证请求签名
    ├─ 查询设备档案
    ├─ 验证会话有效性
    ├─ 查询密钥版本
    │
    ├─ 生成溯源报告
    │   ├─ 关联设备信息
    │   ├─ 关联会话信息
    │   ├─ 计算时间戳
    │   ├─ 收集取证信息
    │   └─ 生成报告摘要
    │
    ├─ 数字签名
    │   ├─ 使用 CA 私钥签名
    │   ├─ 生成签名证书
    │   └─ 时间戳认证
    │
    ├─ 存储与审计
    │   ├─ 保存检测记录
    │   ├─ 保存报告
    │   ├─ 记录审计日志
    │   └─ 上传到审计系统
    │
    └─ 返回报告
        ├─ report_id
        ├─ device_id
        ├─ signature
        ├─ timestamp
        └─ evidence
```

## 6. 模块依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Application)                     │
│  ├─ CLI 工具 (wm-overlay, wm-detect)                        │
│  ├─ REST API 服务                                           │
│  └─ Web UI / 管理后台                                       │
└────────────────┬────────────────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────────────────┐
│                  业务逻辑层 (Business Logic)                │
│  ├─ OverlayService                                          │
│  ├─ Detector                                                │
│  ├─ DeviceManager                                           │
│  ├─ SessionManager                                          │
│  └─ ReportGenerator                                         │
└────────────────┬────────────────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────────────────┐
│                   算法层 (Algorithm)                        │
│  ├─ DWT / IDWT                                              │
│  ├─ DCT / IDCT                                              │
│  ├─ QIM 编码/解码                                           │
│  ├─ 同步模板检测                                            │
│  ├─ 几何校正 (RANSAC)                                       │
│  ├─ BCH / RS 纠错                                           │
│  └─ JND 感知模型                                            │
└────────────────┬────────────────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────────────────┐
│               基础设施层 (Infrastructure)                   │
│  ├─ GPU 渲染 (OpenGL / Metal / DirectX)                     │
│  ├─ 密码学库 (OpenSSL / BoringSSL)                          │
│  ├─ 图像处理库 (OpenCV / libjpeg)                           │
│  ├─ 数据库 (PostgreSQL / MySQL)                             │
│  ├─ 消息队列 (RabbitMQ / Kafka)                             │
│  └─ 缓存 (Redis)                                            │
└─────────────────────────────────────────────────────────────┘
```

## 7. 数据流向

```
设备端                          检测端                        服务端
  │                              │                             │
  ├─ 生成载荷                     │                             │
  ├─ 加密签名                     │                             │
  ├─ 频域嵌入                     │                             │
  ├─ GPU 叠加                     │                             │
  └─ 屏幕显示                     │                             │
      │                          │                             │
      ├─ 翻拍/录屏               │                             │
      │                          │                             │
      └─────────────────────────▶│                             │
                                 ├─ 预处理                     │
                                 ├─ 几何校正                   │
                                 ├─ 频域解码                   │
                                 ├─ 纠错解密                   │
                                 ├─ 置信度评估                 │
                                 │                             │
                                 └─────────────────────────────▶
                                                               ├─ 查询设备
                                                               ├─ 验证会话
                                                               ├─ 生成报告
                                                               ├─ 数字签名
                                                               └─ 存储审计
```

## 8. 密钥管理层级

```
┌─────────────────────────────────────────────────────────────┐
│                    主密钥 (Master Key)                      │
│  - 存储在 KMS 中                                            │
│  - 定期轮换                                                 │
│  - 访问受限                                                 │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ├─────────────────────────────────────────────┐
                 │                                             │
┌────────────────▼──────────────┐        ┌────────────────────▼──┐
│   设备派生密钥 (Device Key)   │        │  会话短期密钥 (Session Key) │
│  - 绑定到 device_id           │        │  - TTL 可配置 (默认 1h)    │
│  - 用于端侧加密               │        │  - 用于当前会话            │
│  - 长期有效                   │        │  - 支持轮换                │
└───────────────────────────────┘        └────────────────────────┘
```

---

**注**：所有架构图均为文本表示，可根据需要转换为 Visio、Lucidchart 等工具的图形化版本。

