一、方案总览（Executive Summary）

### 1.1 核心目标

在不影响用户观感的前提下，于显示画面实时叠加低可见度“暗纹”水印，每台显示器（或每个会话）承载唯一标识。被手机/相机翻拍或录屏后，利用检测软件可从图片/视频中鲁棒解码水印并溯源到具体设备与会话信息。

### 1.2 实现形态（纯软件）

**端侧叠加**：在操作系统桌面合成阶段以透明叠加层（GPU 渲染）方式注入水印掩模
- 不修改显示器硬件与显卡驱动
- 系统级透明叠加，无需应用集成
- 支持多屏、HDR、不同操作系统

**检测解码**：独立的 SDK/CLI/服务端，对采集到的图片或视频进行处理
- 自动几何校正（透视/旋转/缩放）
- 频域水印同步与解码
- 纠错与密码学验证

**管理与溯源**：服务端存储设备/密钥/会话映射，出具可审计的溯源结果
- 设备注册与身份管理
- 会话密钥下发与轮换
- 完整审计链与溯源报告

### 1.3 核心技术点

| 技术 | 作用 | 说明 |
|------|------|------|
| **盲水印** | 无需原图检测 | 频域嵌入 + 同步模板 |
| **DWT+DCT** | 频域嵌入 | 提升压缩/缩放鲁棒性 |
| **QIM量化** | 比特映射 | 对中频系数施加双阱量化 |
| **同步模板** | 几何同步 | 抗旋转/缩放/透视的正弦格栅 |
| **多尺度平铺** | 抗裁剪 | 64×64/128×128 像素单元重复 |
| **BCH/RS纠错** | 抗噪声 | 误差控制码 |
| **JND感知模型** | 不影响观感 | 自适应强度调整，MOS ≥ 4/5 |
| **蓝噪声抖动** | 掩蔽纹理 | 在纯色区域引入随机抖动 |

### 1.4 主要能力

✅ **鲁棒性**：对翻拍中的压缩、缩放、旋转、透视畸变、噪声、模糊、色偏具备鲁棒性

✅ **兼容性**：支持多显示器、高分辨率/HDR、不同操作系统（Windows/macOS/Linux）

✅ **性能指标**：
- 检测性能：TPR ≥ 95%（FPR ≤ 10⁻⁶），EER ≤ 2%
- 可见度：MOS ≥ 4/5，无明显纹理/闪烁/色偏
- 系统占用：CPU < 3%，GPU < 5%（视硬件而定）

✅ **SDK 支持**：C++ 核心库、C#/Java/Swift 包装、CLI 工具、REST 服务

二、需求分析（SRS）

### 2.1 术语与范围

| 术语 | 定义 |
|------|------|
| **屏内水印** | 在显示输出画面上以人眼难察觉的方式叠加的数字水印掩模 |
| **盲检测** | 解码无需原始未加水印的画面，仅从翻拍图像恢复水印 |
| **同步模板** | 用于估计与反演几何畸变（旋转、缩放、透视）的参考结构 |
| **载荷** | 水印中嵌入的信息，包含设备ID、会话ID、时间戳等 |
| **JND** | Just Noticeable Difference，人眼感知阈值 |
| **QIM** | Quantization Index Modulation，量化指数调制 |

### 2.2 角色与使用场景

**角色**：

- **设备方**：显示器/整机厂，负责预置设备身份、部署端侧叠加组件
- **内容方/企业**：希望防止机密屏幕被拍照泄露并可溯源
- **取证方**：将翻拍图片/视频交由检测系统出具溯源报告
- **系统管理员**：负责密钥管理、策略下发、审计日志

**典型场景**：

1. **办公环境泄密取证**
   - 员工用手机翻拍屏幕
   - 审计侧上传样张溯源到显示器 SN 与员工身份

2. **会议室屏幕共享**
   - 会议信息被翻拍
   - 检测绑定到会议会话 ID 与时间戳
   - 追踪信息泄露源头

3. **远程桌面/VDI**
   - 在虚拟桌面客户端层叠加水印
   - 实现跨端口一致溯源
   - 支持多用户并发会话

4. **高保密环境**
   - 涉密信息显示屏防拍照
   - 实时审计与取证
   - 支持离线工作与事后补传

### 2.3 功能性需求（FR）

#### FR-1：水印叠加

- **FR-1.1** 支持按设备 ID 与会话/时间生成唯一载荷
- **FR-1.2** 叠加方式不依赖应用集成（系统级透明叠加）
- **FR-1.3** 支持按显示器区域/多屏坐标系平铺
- **FR-1.4** 支持强度自适应与 JND 控制，肉眼感知差异 < ΔE* 感知阈
- **FR-1.5** 支持多屏独立管理，每屏可配置不同策略
- **FR-1.6** 支持 HDR/SDR 模式自动切换与色域映射

#### FR-2：检测解码

- **FR-2.1** 输入：单帧图片、视频文件或视频流
- **FR-2.2** 自动完成透视/旋转/缩放校正
- **FR-2.3** 鲁棒解码水印载荷
- **FR-2.4** 输出：设备 ID、时间戳/会话 ID、解码置信度、攻击类型估计
- **FR-2.5** 提供完整校验报告与取证辅助信息
- **FR-2.6** 支持多帧融合提升检测成功率

#### FR-3：密钥与身份管理

- **FR-3.1** 载荷加密与签名（AES-GCM + HMAC）
- **FR-3.2** 设备注册、会话发号、密钥轮换与吊销
- **FR-3.3** 结果审计日志、链路追踪
- **FR-3.4** 支持离线工作，网络恢复后补传
- **FR-3.5** 密钥版本管理与向后兼容

#### FR-4：接口与工具

- **FR-4.1** 端侧 SDK（C++ 核心，C#/Java/Swift 包装）
- **FR-4.2** CLI 工具：wm-overlay（端侧监控与诊断）、wm-detect（本地检测）
- **FR-4.3** REST API：/v1/detect、/v1/devices、/v1/sessions、/v1/reports 等
- **FR-4.4** 支持同步与异步检测模式
- **FR-4.5** 支持 API Key 与 Bearer JWT 双通道鉴权

### 2.4 非功能性需求（NFR）

#### NFR-1：鲁棒性目标（常见翻拍工况）

| 工况 | 目标 |
|------|------|
| **压缩** | JPEG 质量 60–95；H.264/H.265 常规码率 |
| **尺度** | 0.4×–2.0× 缩放 |
| **旋转** | ±20° 旋转角 |
| **透视** | 倾斜角 ≤ 25° |
| **裁剪** | 最多 30% 裁剪 |
| **模糊** | 高斯模糊 σ ≤ 1.5px |
| **噪声** | SNR ≥ 18 dB |
| **视频** | 1080p 下 ≥ 25 fps 处理能力 |

#### NFR-2：检测性能目标

- **NFR-2.1** 在基准数据集上：TPR ≥ 95%（FPR ≤ 10⁻⁶）
- **NFR-2.2** EER ≤ 2%（目标值，随场景微调）
- **NFR-2.3** 可见度：主观 MOS ≥ 4/5，无明显纹理/闪烁/色偏
- **NFR-2.4** 端侧 CPU 占用 < 3%，GPU 占用 < 5%（视硬件而定）

#### NFR-3：兼容性

- **NFR-3.1** 操作系统：Windows 10/11、macOS 13+、主流 Linux 桌面
- **NFR-3.2** 显示技术：多显示器、SDR/HDR、不同分辨率与刷新率
- **NFR-3.3** 显示协议：Wayland/X11（条件性支持）
- **NFR-3.4** 显卡驱动：主流 GPU（NVIDIA/AMD/Intel）

#### NFR-4：安全与合规

- **NFR-4.1** 遵循个人信息与员工告知义务
- **NFR-4.2** 支持水印开关策略与审计
- **NFR-4.3** 签名的二进制、反调试与完整性检测
- **NFR-4.4** 接口限流与审计日志
- **NFR-4.5** 密钥加密存储与访问控制

#### NFR-5：可运维性

- **NFR-5.1** 完整日志、指标、链路追踪
- **NFR-5.2** 离线/断网可工作，网络恢复后补传
- **NFR-5.3** 长时间运行无内存/句柄泄漏
- **NFR-5.4** 支持静默升级与版本管理
- **NFR-5.5** Prometheus 指标、集中日志与告警

### 2.5 约束与假设

#### 约束

- **C-1** 不修改显示器硬件与显卡驱动（纯软件实现）
- **C-2** 全屏独占/游戏等场景可能屏蔽最上层叠加，需要白名单/驱动层方案作为增强
- **C-3** Wayland 环境的全局叠加权限受限，需通过桌面扩展或应用内集成兜底
- **C-4** 需对 HDR/色域映射做伽马域与线性域一致性处理
- **C-5** 水印强度与可见度存在权衡，需在用户体验与鲁棒性间平衡

#### 假设

- **A-1** 用户设备具有现代 GPU（支持 OpenGL 3.0+ 或 DirectX 11+）
- **A-2** 显示器支持标准 EDID 信息读取
- **A-3** 翻拍设备（手机/相机）具有合理的光学质量
- **A-4** 网络连接可用于密钥下发与审计上传（离线模式为降级方案）
- **A-5** 系统时钟精度在秒级以上

### 2.6 风险与缓解方案

| 风险 | 影响 | 缓解方案 |
|------|------|--------|
| **可见度与舒适度** | 在低纹理/灰阶背景下更易感知 | 采用内容自适应掩模与蓝噪声抖动 |
| **几何破坏过强** | 超强透视/模糊导致检测失败 | 更强同步模板与时域多帧融合 |
| **平台限制** | 某些系统禁止全局覆盖 | 应用 SDK + IT 策略白名单组合部署 |
| **性能开销** | 端侧 CPU/GPU 占用过高 | 优化算法、使用硬件加速、自适应降级 |
| **密钥泄露** | 水印被伪造 | 密钥加密存储、定期轮换、审计日志 |
| **隐私合规** | 违反数据保护法规 | 用户告知、开关策略、最小留痕 |

三、概要设计（High-Level Design）
3.1 技术路线与数据流
┌──────────┐    ┌────────────────────────────────────────────────────────────┐
│设备/会话ID│→→ │ 端侧叠加服务 (Overlay Service)                            │
└─────┬────┘    │ ①载荷编码+加密 ②同步模板合成 ③JND自适应 ④GPU叠加         │
      │          └──────────┬───────────────────────────────────────────────┘
      │                         屏幕显示（含水印）
      │
翻拍图片/视频  ─────────────────────────────────→  检测端（SDK/CLI/REST）
                                                   │ ①几何同步/校正
                                                   │ ②频域解码(QIM/DWT+DCT)
                                                   │ ③ECC纠错+BCH/RS
                                                   │ ④验签/去噪/融合
                                                   └→ 溯源报告/审计

3.2 水印载荷与密码学

载荷字段（建议 96–128 bit 有效信息 + 冗余）

ver(4) + vendor(12) + model(12) + device_id(32/48)

session_ts(32)（UTC 秒或时间片索引）

nonce(16)（防重放/防拼接）

crc(8)（帧内快速校验）

编码与安全

先用 BCH/RS 纠错（例如 BCH(127,k) 或 RS(255,k)），多副本平铺；

payload_enc = AES-GCM(k_device, payload || aad)；

附带 HMAC-SHA256 对解码消息做二次校验（抗冒充）。

3.3 嵌入算法（端侧叠加）

域选择：图像先做 2 级 DWT，在中频子带（LH/HL）内按块做 8×8 DCT；

量化方式：采用 QIM（Quantization Index Modulation） 对若干中频系数施加双阱量化，实现比特映射；

同步模板：在频谱中叠加两组弱幅正弦格栅（不同方向/频率），用于估计旋转/缩放；网格周期在 16–64 px 之间；

多尺度平铺：以 64×64/128×128 像素为单元，重复嵌入，提升裁剪鲁棒；

JND/可见度控制：基于局部梯度/纹理能量调整嵌入强度 α=α0 * f(local contrast)；在纯色大块区域引入蓝噪声抖动掩蔽。

时域扰动：每 N 帧变换伪随机相位/子载波选择（同一会话密钥下可复原），增强抗去水印滤波。

端侧实现为叠加掩模：通过 GPU 生成近似上述频域效果的空域掩模（预先逆变换得到），以透明层合成到桌面；避免对底层图像做昂贵频域操作。

3.4 解码与同步（检测端）

预处理：自动检测屏幕边缘/内容平面，估计并校正透视（单应性）、旋转、缩放；

频域变换：对校正图做 DWT→分块 DCT；

同步：利用频谱中的格栅峰值定位旋转角与尺度；必要时做 log-polar 搜索微调；

软判决 QIM 解码：每比特在多个块/多尺度/多帧上加权投票；

纠错与解密：BCH/RS 纠错 → AES-GCM 解密 → HMAC 验证；

置信度评估：输出 score∈[0,1]，并估计攻击类型（压缩、模糊、透视强度）。

3.5 端侧组件设计

Overlay Service（常驻进程）

与系统合成器协作（Windows: DirectComposition / DXGI 层；macOS: CoreAnimation/Metal overlay；Linux: X11 overlay 或 Wayland 扩展/应用内兜底）；

多屏管理：读取 EDID/坐标，按物理屏生成独立掩模；

强度自适应：基于 GPU Shader 的局部统计（近邻梯度/方差）；

策略控制：黑/白名单应用、全屏独占检测、HDR 模式识别与映射；

诊断接口：可视化对比（仅管理员可见）、帧级日志（哈希）。

配置与密钥

本地仅存放经设备 KMS 下发的会话短期密钥（短时有效），持久密钥在服务端 KMS；

设备断网可使用上次缓存的短期密钥直至过期。

3.6 检测与服务端

Detect SDK：C++ 核心 + 平台封装；提供本地 API（详见 3.8）。

REST 服务（可容器化）：

POST /v1/detect：上传图片/视频（或 URL/对象存储引用），返回解码结果与置信度；

GET /v1/devices/{id}：查询设备档案；

POST /v1/report：保存与出具溯源报告（含校验链）。

数据存储

devices(device_id, vendor, model, sn, 状态…)

sessions(sid, device_id, key_id, 生效区间…)

detections(hash, ts, payload, score, evidence…)

KMS：密钥主控与轮换审计。

3.7 数据与日志

最小留痕：仅存放必要载荷与审计元数据，不存业务画面内容；

可审计链：请求哈希、算法版本、参数快照、密钥版本、操作者信息；

隐私合规：提供用户告知模板与开关策略（如来宾显示器禁用）。

3.8 SDK / API（示例）

端侧 Overlay SDK（C++）

struct WmConfig {
  std::string device_id;
  std::string endpoint;     // KMS/会话下发
  bool adaptive_strength;   // JND/自适应
  float alpha_base;         // 基准强度 0.0~1.0
};

class OverlayService {
public:
  static OverlayService* Create(const WmConfig& cfg);
  bool Start();             // 创建叠加层、进入渲染循环
  void SetPolicy(const Policy& p); // 应用黑白名单/HDR策略等
  void Stop();
};


检测 SDK（C++）

struct DetectResult {
  bool found;
  std::string device_id;
  uint64_t session_ts;
  double score;             // 0~1
  std::string attack_hint;  // 'jpeg','blur','perspective',...
};

class Detector {
public:
  bool LoadKeyset(const Keyset& k); // 用于解密与验签
  DetectResult FromImage(const Image& img);
  DetectResult FromVideo(const Video& vid, int max_frames=60);
};


REST（节选）

POST /v1/detect
Content-Type: multipart/form-data
--> file=@photo.jpg | video.mp4
<-- 200 {
  "found": true, "score": 0.97,
  "device_id":"ACME-24F-00112233",
  "session_ts": 1739778123,
  "attack_hint":"jpeg+pct=12,persp=8deg",
  "signature":"…",
  "algo_ver":"wm-1.3.2"
}

3.9 关键算法伪代码（简化）

嵌入（生成空域掩模）

payload_bits = ECC_Encode(Encrypt(payload, key))
mask = 0
for scale in SCALES:
  grid = Tile(payload_bits, block_size[scale])
  freq_mask = 0
  for block in grid:
    C = DCT(block_basis)                    # 预生成的频域基块
    C' = QIM_Modulate(C.midfreq, block.bits)
    freq_mask += IDCT(C')
  sync = make_sinusoidal_template(scale)    # 同步模板
  mask += freq_mask + sync

mask = JND_Modulate(mask, local_contrast(screen_snapshot))
overlay = BlueNoiseDither(mask, alpha_base)
CompositeToDesktop(overlay)                 # 透明窗口/GPU 叠加


解码

I = LoadImageOrFrame()
H = EstimateHomography(I)                   # 边线/角点/模板峰值
I' = Warp(I, H^-1)
C = DWT_DCT(I')
bits_soft = []
for tile in tiles:
  bits_soft += QIM_Decode_Soft(C[tile].midfreq)

bits = ECC_Decode(soft_votes=Aggregate(bits_soft))
payload = Decrypt(bits, key)
Verify(HMAC(payload)) ? FOUND : NOT_FOUND

四、测试计划与验收标准
4.1 数据集与工况

设备多样：不同型号/尺寸/面板、亮度模式（SDR/HDR）、刷新率；

终端多样：不同手机品牌/相机、光照环境、拍摄距离/角度；

处理链：不同压缩、滤波、裁剪、转码流程；

多屏与窗口边界情况。

4.2 指标与门槛

主观可见度：双盲 MOS ≥4/5；

检测性能：按 NFR 目标（TPR、FPR、EER）给出 ROC；

性能：端侧 CPU/GPU 占用阈值（如 <3% CPU，<5% GPU，视硬件与分辨率留有余量）；

稳定性：长时间运行无内存/句柄泄漏；

兼容：在目标 OS/显卡驱动/HDR 组合下通过互测。

4.3 验收工单

功能用例覆盖 ≥95%；

边界场景（全屏独占、HDR 切换、扩展坞热插拔）均有稳定降级策略；

审计链条闭环（请求→解码→报告→追溯）。

五、部署与运维

端侧：MSI/PKG/DEB 安装；以系统服务常驻；策略由 MDM/组策略下发；支持静默升级。

服务端：容器化部署（API+KMS+DB），提供 Prometheus 指标、集中日志与告警阈值。

密钥管理：KMS 主密钥 + 设备派生密钥 + 会话短期密钥；支持滚动与吊销。

安全：签名的二进制、反调试与完整性检测；接口限流与审计。

六、已知限制与扩展路径

某些全屏独占/反覆盖应用（高防作弊游戏、DRM 播放）会阻断叠加；

扩展路径：与厂商合作的图形驱动层过滤器或应用内嵌 SDK。

Wayland 全局叠加受控；

扩展路径：桌面环境扩展（Shell Extension）或仅在受控应用中叠加。

HDR 不同 EOTF/色域映射带来强度不一致；

扩展路径：在线映射标定表与传感自适应。

七、实施里程碑（不含时间承诺）

立项与需求冻结 → 参考实现路线与指标确认

原型阶段（PoC）：算法链路与叠加可见度验证

Beta：跨平台叠加、检测 SDK、REST 服务与运维打通

上线准备：指标验收、合规审计、灰度与回滚策略

规模化：多机型适配、性能与鲁棒性持续优化

下面是**“屏内数字水印溯源”REST API 的 Swagger（OpenAPI 3.1）规范**。可直接复制到 Swagger Editor
 或任何支持 OpenAPI 3.1 的工具中查看与生成客户端 SDK/服务端桩代码。

openapi: 3.1.0
info:
  title: 屏内数字水印溯源 API
  version: 1.0.0
  summary: 纯软件实现的屏内水印检测/溯源与设备/会话管理接口
  description: |
    提供图片/视频中的屏内水印检测、溯源报告出具、设备与会话密钥管理等能力。
    - 支持同步/异步检测
    - 支持多种鉴权（API Key / Bearer JWT）
    - 采用 RFC7807 Problem Details 作为错误返回格式
  contact:
    name: Watermark Team
    email: watermark@example.com
servers:
  - url: https://api.example.com
    description: 生产环境
  - url: https://staging-api.example.com
    description: 预发布/测试环境
security:
  - ApiKeyAuth: []
  - BearerAuth: []
tags:
  - name: Health
    description: 健康检查与版本信息
  - name: Detect
    description: 图片/视频水印检测
  - name: Detections
    description: 检测任务查询
  - name: Devices
    description: 设备注册与查询
  - name: Sessions
    description: 会话密钥发放与查询
  - name: Reports
    description: 溯源报告出具与查询
paths:
  /v1/ping:
    get:
      tags: [Health]
      summary: 健康检查
      operationId: getPing
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, example: ok }
                  version: { type: string, example: wm-1.3.2 }
                  time: { type: string, format: date-time }
  /v1/detect:
    post:
      tags: [Detect]
      summary: 提交图片/视频进行水印检测（同步或异步）
      description: |
        - 同步：`async=false`（默认），小/中等文件即时返回检测结果  
        - 异步：`async=true`，返回任务 ID，稍后用 **GET /v1/detections/{id}** 查询
      operationId: postDetect
      parameters:
        - in: query
          name: async
          description: 是否异步处理
          required: false
          schema: { type: boolean, default: false }
        - in: query
          name: max_frames
          description: 对视频抽帧的最大帧数（同步模式下建议 1–60）
          required: false
          schema: { type: integer, minimum: 1, maximum: 300, default: 60 }
        - in: query
          name: media_kind
          description: 媒体类型（自动/图片/视频）
          required: false
          schema:
            type: string
            enum: [auto, image, video]
            default: auto
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: 图片或视频文件
                return_payload:
                  type: boolean
                  default: true
                  description: 返回明文载荷（若具备解密权限）
            encoding:
              file:
                contentType: [image/jpeg, image/png, image/heic, video/mp4, video/quicktime, video/x-matroska]
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  format: uri
                  description: 待检测媒体的可访问地址（对象存储/内网 URL）
                return_payload:
                  type: boolean
                  default: true
      responses:
        '200':
          description: 同步检测完成
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetectionResult'
        '202':
          description: 已接受异步检测任务
          content:
            application/json:
              schema:
                type: object
                properties:
                  detection_id: { type: string, example: det_01HV6Z4W7M2R6Z9KQ2S5W9Q8A1 }
                  status_url: { type: string, format: uri, example: https://api.example.com/v1/detections/det_01HV6... }
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/ServerError'
  /v1/detections:
    get:
      tags: [Detections]
      summary: 分页查询检测记录
      operationId: listDetections
      parameters:
        - in: query
          name: device_id
          schema: { type: string }
          description: 过滤某设备 ID 的记录
        - in: query
          name: from
          schema: { type: string, format: date-time }
          description: 起始时间（ISO8601）
        - in: query
          name: to
          schema: { type: string, format: date-time }
          description: 截止时间（ISO8601）
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/DetectionRecord' }
                  page: { type: integer }
                  page_size: { type: integer }
                  total: { type: integer }
        '401': { $ref: '#/components/responses/Unauthorized' }
  /v1/detections/{id}:
    get:
      tags: [Detections]
      summary: 查询单个检测任务/结果
      operationId: getDetection
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/DetectionResult'
                  - $ref: '#/components/schemas/DetectionPending'
        '404': { $ref: '#/components/responses/NotFound' }
  /v1/devices/enroll:
    post:
      tags: [Devices]
      summary: 设备注册/入网（分配设备密钥与档案）
      operationId: enrollDevice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeviceEnrollRequest'
      responses:
        '201':
          description: 已创建
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Device' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '409': { $ref: '#/components/responses/Conflict' }
  /v1/devices/{device_id}:
    get:
      tags: [Devices]
      summary: 查询设备档案
      operationId: getDevice
      parameters:
        - in: path
          name: device_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Device' }
        '404': { $ref: '#/components/responses/NotFound' }
    patch:
      tags: [Devices]
      summary: 更新设备状态/元数据（启停/吊销等）
      operationId: patchDevice
      parameters:
        - in: path
          name: device_id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [active, suspended, revoked]
                metadata:
                  type: object
                  additionalProperties: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Device' }
        '404': { $ref: '#/components/responses/NotFound' }
  /v1/sessions:
    post:
      tags: [Sessions]
      summary: 创建会话并下发短期会话密钥（端侧叠加使用）
      operationId: createSession
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SessionCreateRequest' }
      responses:
        '201':
          description: 已创建
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Session' }
        '400': { $ref: '#/components/responses/BadRequest' }
  /v1/sessions/{sid}:
    get:
      tags: [Sessions]
      summary: 查询会话
      operationId: getSession
      parameters:
        - in: path
          name: sid
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Session' }
        '404': { $ref: '#/components/responses/NotFound' }
  /v1/reports:
    post:
      tags: [Reports]
      summary: 出具溯源报告（对既有检测结果签名存证）
      operationId: createReport
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ReportCreateRequest' }
      responses:
        '201':
          description: 已创建
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Report' }
        '400': { $ref: '#/components/responses/BadRequest' }
    get:
      tags: [Reports]
      summary: 分页查询报告
      operationId: listReports
      parameters:
        - in: query
          name: device_id
          schema: { type: string }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Report' }
                  page: { type: integer }
                  page_size: { type: integer }
                  total: { type: integer }
  /v1/reports/{rid}:
    get:
      tags: [Reports]
      summary: 获取单个报告
      operationId: getReport
      parameters:
        - in: path
          name: rid
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Report' }
        '404': { $ref: '#/components/responses/NotFound' }

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: 平台分配的 API Key
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  responses:
    BadRequest:
      description: 请求参数错误
      content: { application/problem+json: { schema: { $ref: '#/components/schemas/Problem' } } }
    Unauthorized:
      description: 未认证或凭证无效
      content: { application/problem+json: { schema: { $ref: '#/components/schemas/Problem' } } }
    NotFound:
      description: 资源不存在
      content: { application/problem+json: { schema: { $ref: '#/components/schemas/Problem' } } }
    Conflict:
      description: 资源冲突（例如已注册）
      content: { application/problem+json: { schema: { $ref: '#/components/schemas/Problem' } } }
    PayloadTooLarge:
      description: 请求体过大
      content: { application/problem+json: { schema: { $ref: '#/components/schemas/Problem' } } }
    UnsupportedMediaType:
      description: 不支持的媒体类型
      content: { application/problem+json: { schema: { $ref: '#/components/schemas/Problem' } } }
    TooManyRequests:
      description: 触发限流
      content: { application/problem+json: { schema: { $ref: '#/components/schemas/Problem' } } }
    ServerError:
      description: 服务端错误
      content: { application/problem+json: { schema: { $ref: '#/components/schemas/Problem' } } }
  schemas:
    Problem:
      title: ProblemDetails
      type: object
      properties:
        type: { type: string, format: uri, example: about:blank }
        title: { type: string, example: Bad Request }
        status: { type: integer, example: 400 }
        detail: { type: string, example: 参数 media_kind 无效 }
        instance: { type: string, format: uri, example: /v1/detect }
        code: { type: string, example: INVALID_MEDIA_KIND }
      required: [title, status]
    DetectionPending:
      type: object
      properties:
        detection_id: { type: string, example: det_01HV6Z4W7M... }
        status: { type: string, enum: [pending, running], example: pending }
        queued_at: { type: string, format: date-time }
        eta_seconds: { type: integer, minimum: 0, example: 12 }
    DetectionRecord:
      type: object
      properties:
        id: { type: string, example: det_01HV6Z4W7M... }
        created_at: { type: string, format: date-time }
        media_kind: { type: string, enum: [image, video] }
        device_id: { type: string, nullable: true, description: 若解码失败可能为空 }
        score: { type: number, format: float, minimum: 0, maximum: 1 }
        found: { type: boolean }
        attack_hint: { type: string, example: "jpeg+pct=12,persp=8deg" }
    DetectionResult:
      type: object
      properties:
        detection_id: { type: string, example: det_01HV6Z4W7M... }
        found: { type: boolean, example: true }
        score: { type: number, format: float, minimum: 0, maximum: 1, example: 0.97 }
        device_id: { type: string, example: ACME-24F-00112233 }
        session_ts: { type: integer, format: int64, example: 1739778123, description: Unix 秒级时间戳 }
        session_id: { type: string, example: sid_9fQ2kd... }
        media_kind: { type: string, enum: [image, video], example: image }
        attack_hint: { type: string, example: "jpeg+pct=12,persp=8deg" }
        algo_ver: { type: string, example: wm-1.3.2 }
        signature: { type: string, example: "base64-encoded-signature" }
        payload:
          type: object
          nullable: true
          description: 若调用方有权限且 return_payload=true，则返回解密后的载荷字段
          properties:
            ver: { type: integer, example: 1 }
            vendor: { type: string, example: ACME }
            model: { type: string, example: X24U }
            nonce: { type: string, example: 1a2b3c4d }
          additionalProperties: true
        evidence:
          type: object
          description: 取证辅助信息（可选）
          properties:
            perspective_corners:
              type: array
              items:
                type: array
                items: { type: number }
              example: [[12.3, 45.6], [1012.7, 30.2], [1005.4, 560.1], [24.8, 572.9]]
            homography:
              type: array
              description: 3x3 单应矩阵（行主序）
              items: { type: number }
              example: [0.98, -0.01, 12.3, 0.02, 0.97, 8.4, 0.0001, -0.0002, 1.0]
            frames_used: { type: integer, example: 37 }
        created_at: { type: string, format: date-time }
    DeviceEnrollRequest:
      type: object
      required: [device_id, vendor, model]
      properties:
        device_id: { type: string, example: ACME-24F-00112233 }
        vendor: { type: string, example: ACME }
        model: { type: string, example: X24U }
        serial_number: { type: string, example: SN1234567890 }
        metadata:
          type: object
          additionalProperties: { type: string }
    Device:
      type: object
      properties:
        device_id: { type: string }
        vendor: { type: string }
        model: { type: string }
        serial_number: { type: string }
        status:
          type: string
          enum: [active, suspended, revoked]
          example: active
        key_id: { type: string, example: key_7aG52... }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
        metadata:
          type: object
          additionalProperties: { type: string }
    SessionCreateRequest:
      type: object
      required: [device_id]
      properties:
        device_id: { type: string, example: ACME-24F-00112233 }
        ttl_seconds:
          type: integer
          minimum: 60
          maximum: 86400
          default: 3600
        purpose:
          type: string
          example: "overlay-runtime"
    Session:
      type: object
      properties:
        sid: { type: string, example: sid_9fQ2kd... }
        device_id: { type: string }
        key_id: { type: string, example: key_7aG52... }
        valid_from: { type: string, format: date-time }
        valid_to: { type: string, format: date-time }
        purpose: { type: string }
        created_at: { type: string, format: date-time }
    ReportCreateRequest:
      type: object
      required: [detection_id]
      properties:
        detection_id: { type: string }
        reviewer: { type: string, example: "security.officer@example.com" }
        notes: { type: string, example: "与员工 A 的工位显示器匹配，建议进一步复核。" }
    Report:
      type: object
      properties:
        rid: { type: string, example: rpt_01J2W... }
        detection_id: { type: string }
        device_id: { type: string }
        signed_at: { type: string, format: date-time }
        signer: { type: string, example: "CN=WM-CA,O=ACME" }
        signature: { type: string, example: "base64-encoded-signature" }
        notes: { type: string }
        hash: { type: string, example: "sha256:1b2c..." }

快速示例（cURL）

同步检测图片

curl -X POST 'https://api.example.com/v1/detect?async=false&media_kind=image' \
  -H 'X-API-Key: <YOUR_API_KEY>' \
  -F 'file=@/path/to/photo.jpg' \
  -F 'return_payload=true'


异步检测视频并轮询结果

# 提交
curl -X POST 'https://api.example.com/v1/detect?async=true&max_frames=60' \
  -H 'Authorization: Bearer <YOUR_JWT>' \
  -F 'file=@/path/to/capture.mp4'

# 查询
curl -X GET 'https://api.example.com/v1/detections/det_01HV6Z4W7M...' \
  -H 'Authorization: Bearer <YOUR_JWT>'


注册设备并下发会话密钥

curl -X POST 'https://api.example.com/v1/devices/enroll' \
  -H 'X-API-Key: <YOUR_API_KEY>' -H 'Content-Type: application/json' \
  -d '{"device_id":"ACME-24F-00112233","vendor":"ACME","model":"X24U","serial_number":"SN123"}'

curl -X POST 'https://api.example.com/v1/sessions' \
  -H 'Authorization: Bearer <YOUR_JWT>' -H 'Content-Type: application/json' \
  -d '{"device_id":"ACME-24F-00112233","ttl_seconds":3600,"purpose":"overlay-runtime"}'

备注

鉴权：建议服务整体启用 API Key（对只读/检测）与 Bearer JWT（对管理操作）双通道。mTLS 可在网关层配置（不在 OpenAPI 中声明）。

异步检测：大文件、长视频建议使用 async=true，以避免连接超时。

兼容：multipart/form-data 与 application/json(url) 二选一提交媒体。